# ADR-0002: 基于损失变化率的比例控制权重衰减 (PC-WD)

- **状态**: 已提议
- **日期**: 2025-12-09
- **决策者**: Ω Researcher

## 背景

先前的研究（ADR-0001，RMSuon 长期训练实验）表明，固定的 L2 权重衰减无法有效正则化 `RMSuon` 等几何优化器，且与优化器的内在动力学不匹配。我们需要一种能够动态适应训练状态的正则化机制。

根据自由能原理（FEP），智能体通过最小化“惊讶”（预测误差/损失）来学习。一个仍在有效降低损失的系统，表明其尚未达到最优的模型复杂度。从学习心理学和奥卡姆剃刀原则出发，我们可以构建一个启发式规则：“只要我还在进步，就说明存在更简单的解释，我应该主动简化我的模型。”

## 决策

我们决定设计并实现一种**基于损失变化率的比例控制权重衰减（Proportional-Control Weight Decay, PC-WD）**机制。该机制将权重衰减系数 `λ` 与训练损失的变化率直接挂钩，形成一个动态反馈回路。

### 算法形式化

1. **维护损失的 EMA**:
    为滤除高频噪声，我们使用损失的指数移动平均（EMA）作为基准。
    `L_EMA,t = β * L_EMA,t-1 + (1-β) * L_t`

2. **计算损失变化率信号 (ΔL̃)**:
    `ΔL̃_t = L_EMA,t - L_EMA,t-1`
    该信号反映了平滑后的损失变化趋势。

3. **信号变换与放大**:
    由于 `ΔL̃_t` 的值域通常很小，需要进行非线性变换以获得有效的控制信号。我们采用负对数函数进行放大。
    `control_signal_t = -log(|ΔL̃_t| + ε)`
    当 `ΔL̃_t` 趋近于0时，控制信号趋向于无穷大，提供了强烈的响应。

4. **更新控制律**:
    权重衰减 `λ` 根据 `ΔL̃_t` 的符号和 `control_signal_t` 的大小进行乘性调制。
    - **if `ΔL̃_t < 0` (损失下降，仍在学习)**:
      `λ_{t+1} = λ_t * (1 + α * control_signal_t)`
      *增加*正则化压力，迫使模型寻找更简单的解。
    - **if `ΔL̃_t >= 0` (损失上升或停滞，可能过拟合)**:
      `λ_{t+1} = λ_t / (1 + α * control_signal_t)`
      *降低*正则化压力，给予模型更多探索自由。

    `α` 是一个控制调制强度的超参数。

5. **安全性保证**:
    - **训练集信号**: 整个控制回路仅使用**训练集**的损失，杜绝了任何来自验证集的信息泄露。
    - **边界约束**: `λ` 将被限制在一个预设的合理范围内 `[λ_min, λ_max]`，防止其值爆炸或消失。

## 后果

### 积极

- **理论一致性 (FEP/IPWT)**: 该机制是自由能原理（FEP）在正则化问题上的直接工程应用。在变分推断框架下，自由能 `F` 可分解为 `F = D_KL[q(θ) || p(θ)] - E_q[ln p(D|θ)]`，即**复杂度**减去**准确度**。L2权重衰减 `λ||θ||²` 等价于为参数 `θ` 设定一个零均值高斯先验 `p(θ) = N(0, 1/(2λ)I)`，此时 `λ` 直接控制了复杂度项 `D_KL` 的强度。PC-WD 通过将 `λ` 与准确度项的变化 `ΔL̃` 挂钩，实现了对复杂度项的动态、自适应控制。当准确度仍在提升（`ΔL̃ < 0`）时，系统主动增加 `λ`（收紧高斯先验），迫使模型寻找更简单的解；当准确度下降（`ΔL̃ > 0`）时，系统放松 `λ`（放宽高斯先验），允许模型探索更复杂的解。这构成了最小化自由能 `F` 的完整反馈回路。更深层次地，该机制与 FEP 的另一条路径——**RL-EFE**——形成了优美的**对偶性**。RL-EFE 通过对 VAE **潜空间**的 KL 散度进行正则化，来约束**表征的复杂度**；而 PC-WD 则通过对**参数空间**的 KL 散度（即权重衰减）进行正则化，来约束**实现的复杂度**。二者分别在概念层和实现层执行了相同的“最小描述长度”原则，PC-WD 因此是 SOO-OFE 路径下对偶于潜空间正则化的关键机制。
- **动态自适应**: `λ` 能够根据模型的真实学习状态动态调整，有望比任何固定或预设的衰减策略更有效。
- **计算高效**: 增加的计算成本极低，仅涉及 EMA 和少量浮点运算。

### 消极

- **引入新超参**: 引入了调制强度 `α`、EMA 平滑因子 `β` 以及 `λ` 的边界 `[λ_min, λ_max]` 等新的超参数，需要进行调整。
- **敏感性风险**: 控制系统可能对 `α` 和信号放大函数的形式敏感，需要实验验证其鲁棒性。

## 考虑的备选方案

### 损失EMA控制方案 (ADR-0001 变体)

- **描述**: 直接比较当前损失 `L_t` 与其 EMA `L_EMA,t-1`，并使用固定的乘性因子 `γ_inc` / `γ_dec` 进行调整。
- **拒绝理由**: 该方案虽然也使用了 EMA，但其控制信号是一个二元的布尔值（`L_t > L_EMA`），缺乏比例性。PC-WD 使用了连续的 `ΔL̃` 作为信号，能够更精细、更成比例地进行反馈控制，理论上更为优越。

